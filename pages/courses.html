<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Career Lens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>

    <div class="courses-page page-container">
        <div class="container py-5">
            <!-- Page Header -->
            <div class="page-header text-center mb-5">
                <h1 class="display-4 gradient-text">Skill Development Courses</h1>
                <p class="lead">Master the skills you need for your dream career</p>
            </div>

            <!-- Course Filters -->
            <div class="course-filters mb-5">
                <div class="row">
                    <div class="col-md-3">
                        <select class="form-select" id="departmentFilter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="levelFilter">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="platformFilter">
                            <option value="">All Platforms</option>
                            <option value="udemy">Udemy</option>
                            <option value="coursera">Coursera</option>
                            <option value="edx">edX</option>
                            <option value="freecodecamp">freeCodeCamp</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Search courses..." id="searchFilter">
                    </div>
                </div>
            </div>

            <!-- Course Grid -->
            <div class="course-grid" id="courseGrid">
                <!-- Courses loaded by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Courses functionality
        class Courses {
            constructor() {
                this.departments = window.appData?.departments || [];
                this.courses = this.getCourses();
                this.filteredCourses = [...this.courses];
                
                this.init();
            }
            
            init() {
                this.initDepartmentFilter();
                this.renderCourses();
                this.initFilters();
                this.initEventListeners();
            }
            
            initEventListeners() {
                // Use event delegation for enroll buttons
                const courseGrid = document.getElementById('courseGrid');
                if (courseGrid) {
                    courseGrid.addEventListener('click', (e) => {
                        const enrollBtn = e.target.closest('.enroll-btn');
                        if (enrollBtn) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const courseId = parseInt(enrollBtn.getAttribute('data-course-id'));
                            
                            if (courseId) {
                                this.enrollCourse(courseId);
                            } else {
                                this.showNotification('Error: Invalid course ID', 'error');
                            }
                        }
                    });
                }
            }
            
            initDepartmentFilter() {
                const deptFilter = document.getElementById('departmentFilter');
                if (deptFilter && this.departments.length > 0) {
                    this.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = dept.name;
                        deptFilter.appendChild(option);
                    });
                }
            }
            
            getCourses() {
                // Generate courses based on career paths and their skills
                const courses = [];
                let courseId = 1;
                
                if (!this.departments || this.departments.length === 0) {
                    return this.getDefaultCourses();
                }
                
                this.departments.forEach(dept => {
                    if (dept.careerPaths) {
                        dept.careerPaths.forEach(path => {
                            // Create one comprehensive course per career path
                            const allSkills = path.skills.map(s => s.name);
                            courses.push({
                                id: courseId++,
                                title: `${path.title} - Complete Course`,
                                instructor: "Industry Expert",
                                platform: this.getRandomPlatform(),
                                department: dept.name,
                                careerPath: path.title,
                                level: path.difficulty.toLowerCase() === 'advanced' ? 'advanced' : 
                                       path.difficulty.toLowerCase() === 'intermediate' ? 'intermediate' : 'beginner',
                                duration: this.getDuration(path.timeToHire),
                                rating: (4.5 + Math.random() * 0.5).toFixed(1),
                                students: this.getRandomStudents(),
                                price: this.getRandomPrice(),
                                skills: allSkills
                            });
                        });
                    }
                });
                
                return courses.length > 0 ? courses : this.getDefaultCourses();
            }
            
            getDefaultCourses() {
                return [
                    {
                        id: 1,
                        title: "The Complete Web Developer Bootcamp 2024",
                        instructor: "Dr. Angela Yu",
                        platform: "Udemy",
                        department: "Computer Science & Engineering",
                        careerPath: "Full Stack Developer",
                        level: "beginner",
                        duration: "65 hours",
                        rating: 4.7,
                        students: "1,200,000+",
                        price: "$89.99",
                        skills: ["JavaScript", "React", "Node.js", "SQL"]
                    }
                ];
            }
            
            getRandomPlatform() {
                const platforms = ["Udemy", "Coursera", "edX", "LinkedIn Learning"];
                return platforms[Math.floor(Math.random() * platforms.length)];
            }
            
            getDuration(timeToHire) {
                // Convert timeToHire to course duration
                if (timeToHire.includes('2-4')) return "2-3 months";
                if (timeToHire.includes('3-5')) return "3-4 months";
                if (timeToHire.includes('4-6')) return "4-5 months";
                if (timeToHire.includes('6-12')) return "6-9 months";
                return "3-6 months";
            }
            
            getRandomStudents() {
                const counts = ["50,000+", "100,000+", "250,000+", "500,000+", "1,000,000+"];
                return counts[Math.floor(Math.random() * counts.length)];
            }
            
            getRandomPrice() {
                const prices = ["$89.99", "$49/month", "$99.99", "Free", "$79.99"];
                return prices[Math.floor(Math.random() * prices.length)];
            }
            
            renderCourses() {
                const container = document.getElementById('courseGrid');
                if (!container) return;
                
                // Get enrolled courses to check enrollment status
                const userData = JSON.parse(localStorage.getItem('careerLensUser')) || {};
                const enrolledCourseIds = (userData.enrolledCourses || []).map(c => typeof c === 'object' ? c.id : c);
                
                container.innerHTML = this.filteredCourses.map(course => {
                    const isEnrolled = enrolledCourseIds.includes(course.id);
                    return `
                    <div class="course-card mb-4">
                        <div class="course-header">
                            <div class="course-badge">${course.platform}</div>
                            <div class="course-rating">
                                <i class="fas fa-star"></i> ${course.rating}
                                <small>(${course.students})</small>
                            </div>
                        </div>
                        <div class="course-body">
                            <h4 class="course-title">${course.title}</h4>
                            <p class="course-instructor">By ${course.instructor}</p>
                            <div class="course-meta">
                                <span><i class="fas fa-clock"></i> ${course.duration}</span>
                                <span><i class="fas fa-signal"></i> ${course.level}</span>
                                <span><i class="fas fa-building"></i> ${course.department || 'General'}</span>
                            </div>
                            ${course.careerPath ? `<p class="text-muted small mb-2"><i class="fas fa-road"></i> Career Path: ${course.careerPath}</p>` : ''}
                            <div class="course-skills">
                                ${course.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            </div>
                        </div>
                        <div class="course-footer">
                            <span class="course-price">${course.price}</span>
                            <button class="btn ${isEnrolled ? 'btn-outline-danger' : 'btn-gradient'} enroll-btn" 
                                    data-course-id="${course.id}"
                                    data-enrolled="${isEnrolled}">
                                ${isEnrolled ? '<i class="fas fa-times me-2"></i>Unenroll' : '<i class="fas fa-plus me-2"></i>Enroll Now'}
                            </button>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            initFilters() {
                // Department filter
                const deptFilter = document.getElementById('departmentFilter');
                if (deptFilter) {
                    deptFilter.addEventListener('change', (e) => {
                        this.applyFilters();
                    });
                }
                
                // Level filter
                const levelFilter = document.getElementById('levelFilter');
                if (levelFilter) {
                    levelFilter.addEventListener('change', (e) => {
                        this.applyFilters();
                    });
                }
                
                // Platform filter
                const platformFilter = document.getElementById('platformFilter');
                if (platformFilter) {
                    platformFilter.addEventListener('change', (e) => {
                        this.applyFilters();
                    });
                }
                
                // Search filter
                const searchFilter = document.getElementById('searchFilter');
                if (searchFilter) {
                    searchFilter.addEventListener('input', (e) => {
                        this.applyFilters();
                    });
                }
            }
            
            applyFilters() {
                const department = document.getElementById('departmentFilter')?.value || '';
                const level = document.getElementById('levelFilter')?.value || '';
                const platform = document.getElementById('platformFilter')?.value || '';
                const search = document.getElementById('searchFilter')?.value.toLowerCase() || '';
                
                this.filteredCourses = this.courses.filter(course => {
                    // Department filter
                    if (department && course.department !== department) return false;
                    
                    // Level filter
                    if (level && course.level !== level) return false;
                    
                    // Platform filter
                    if (platform && course.platform.toLowerCase() !== platform) return false;
                    
                    // Search filter
                    if (search) {
                        const searchable = `${course.title} ${course.instructor} ${course.skills.join(' ')} ${course.careerPath || ''}`.toLowerCase();
                        if (!searchable.includes(search)) return false;
                    }
                    
                    return true;
                });
                
                this.renderCourses();
            }
            
            enrollCourse(courseId) {
                if (!courseId) {
                    this.showNotification('Error: Course ID not found', 'error');
                    return;
                }
                
                const course = this.courses.find(c => c.id === courseId);
                if (!course) {
                    this.showNotification('Course not found', 'error');
                    return;
                }
                
                // Get user data
                const userData = JSON.parse(localStorage.getItem('careerLensUser')) || {
                    id: Date.now(),
                    name: "New User",
                    email: "",
                    department: null,
                    skills: [],
                    enrolledCourses: [],
                    completedCourses: [],
                    savedJobs: [],
                    progress: {},
                    preferences: {
                        theme: 'light',
                        notifications: true
                    }
                };
                
                // Check if already enrolled
                const enrolledCourseIds = (userData.enrolledCourses || []).map(c => typeof c === 'object' ? c.id : c);
                const isEnrolled = enrolledCourseIds.includes(courseId);
                
                if (isEnrolled) {
                    // Unenroll from course
                    if (confirm(`Are you sure you want to unenroll from "${course.title}"?`)) {
                        // Remove from enrolled courses
                        userData.enrolledCourses = (userData.enrolledCourses || []).filter(c => {
                            const id = typeof c === 'object' ? c.id : c;
                            return id !== courseId;
                        });
                        
                        // Remove progress (optional - you might want to keep it)
                        if (userData.progress && userData.progress[courseId] !== undefined) {
                            delete userData.progress[courseId];
                        }
                        
                        // Save to localStorage
                        localStorage.setItem('careerLensUser', JSON.stringify(userData));
                        
                        // Re-render courses to update button states
                        this.renderCourses();
                        
                        this.showNotification(`Unenrolled from: ${course.title}`, 'info');
                    }
                } else {
                    // Enroll in course
                    // Create course object to save
                    const courseToSave = {
                        id: course.id,
                        title: course.title,
                        instructor: course.instructor,
                        platform: course.platform,
                        department: course.department,
                        careerPath: course.careerPath,
                        level: course.level,
                        duration: course.duration,
                        rating: course.rating,
                        students: course.students,
                        price: course.price,
                        skills: course.skills || [],
                        enrolledDate: new Date().toISOString(),
                        progress: 0 // Start with 0% progress
                    };
                    
                    // Add to enrolled courses
                    if (!userData.enrolledCourses) {
                        userData.enrolledCourses = [];
                    }
                    userData.enrolledCourses.push(courseToSave);
                    
                    // Initialize progress for this course
                    if (!userData.progress) {
                        userData.progress = {};
                    }
                    userData.progress[courseId] = 0;
                    
                    // Save to localStorage
                    localStorage.setItem('careerLensUser', JSON.stringify(userData));
                    
                    // Re-render courses to update button states
                    this.renderCourses();
                    
                    this.showNotification(`Successfully enrolled in: ${course.title}!`, 'success');
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span style="margin-left: 0.5rem;">${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }
        
        // Initialize courses
        let coursesInstance;
        if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
                coursesInstance = new Courses();
                window.courses = coursesInstance;
                console.log('Courses initialized');
        });
        } else {
            coursesInstance = new Courses();
            window.courses = coursesInstance;
            console.log('Courses initialized (DOM already loaded)');
        }
    </script>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button id="themeToggle" class="btn btn-sm">
            <i class="fas fa-moon"></i>
            <i class="fas fa-sun"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../scripts/navigation.js"></script>
    <script src="../scripts/theme-manager.js"></script>
    <script src="../scripts/dummy-data.js"></script>
</body>
</html>