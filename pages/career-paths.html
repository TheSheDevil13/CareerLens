<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Paths - Career Lens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/animations.css">
</head>
<body>
    <!-- Navigation (standardized) -->

    <div class="career-paths-page page-container">
        <!-- Department Selector with 3D Cards -->
        <section id="department-selector" class="section-light">
            <div class="container">
                <div class="section-header">
                    <h2>Select Your Department</h2>
                    <p>Choose your academic background to get personalized guidance</p>
                </div>
                
                <div class="department-filters">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="stem">STEM</button>
                        <button class="filter-btn" data-filter="business">Business</button>
                        <button class="filter-btn" data-filter="arts">Arts & Humanities</button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="departmentSearch" placeholder="Search departments...">
                    </div>
                </div>
                
                <div class="row" id="departmentGrid">
                    <!-- Departments loaded via JavaScript -->
                </div>
                
                <div class="text-center mt-5">
                    <button id="loadMoreDepartments" class="btn btn-outline-primary">
                        <i class="fas fa-plus-circle me-2"></i>Load More Departments
                    </button>
                </div>
            </div>
        </section>

        <div class="container py-5">
            <!-- Page Header -->
            <div class="page-header text-center mb-5" style="display: none;">
                <h1 class="display-4 gradient-text">Explore Career Paths</h1>
                <p class="lead">Discover detailed roadmaps for different career paths based on your department</p>
            </div>

            <!-- Career Path Details -->
            <div class="career-path-details" id="pathDetails" style="display: none;">
                <div class="path-header mb-4">
                    <button class="btn btn-outline-primary mb-3" id="backToDepartments">
                        <i class="fas fa-arrow-left me-2"></i>Back to Departments
                    </button>
                    <h2 id="pathTitle">Career Path Title</h2>
                    <p id="pathDescription" class="text-muted"></p>
                </div>

                <!-- Roadmap Timeline -->
                <div class="roadmap-section mb-5">
                    <h3 class="mb-4">Learning Roadmap</h3>
                    <div class="timeline" id="roadmapTimeline">
                        <!-- Timeline items loaded by JavaScript -->
                    </div>
                </div>

                <!-- Skills Required -->
                <div class="skills-section mb-5">
                    <h3 class="mb-4">Required Skills</h3>
                    <div class="row" id="skillsGrid">
                        <!-- Skills loaded by JavaScript -->
                    </div>
                </div>

                <!-- Course Recommendations -->
                <div class="courses-section mb-5">
                    <h3 class="mb-4">Recommended Courses</h3>
                    <div class="row" id="coursesGrid">
                        <!-- Courses loaded by JavaScript -->
                    </div>
                </div>

                <!-- Job Opportunities -->
                <div class="jobs-section">
                    <h3 class="mb-4">Job Opportunities</h3>
                    <div class="row" id="jobsGrid">
                        <!-- Jobs loaded by JavaScript -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button id="themeToggle" class="btn btn-sm">
            <i class="fas fa-moon"></i>
            <i class="fas fa-sun"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../scripts/navigation.js"></script>
    <script src="../scripts/theme-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../scripts/dummy-data.js"></script>
    <script src="../scripts/main.js"></script>
    <script>
        // Career Paths functionality
        class CareerPaths {
            constructor() {
                this.departments = window.appData?.departments || [];
                this.selectedDepartment = null;
                this.selectedPath = null;
                this.selectedPath1 = null;
                this.selectedPath2 = null;
                this.comparisonChart = null;
                
                this.init();
            }
            
            init() {
                // Override exploreDepartment to work on this page
                // This needs to happen after main.js loads but before buttons are clicked
                const overrideExplore = () => {
                    if (window.app) {
                        // Store original function for navigation from other pages
                        if (!window.app._originalExploreDepartment) {
                            window.app._originalExploreDepartment = window.app.exploreDepartment;
                        }
                        // Override for this page
                        window.app.exploreDepartment = (deptId) => {
                            this.selectDepartment(deptId);
                        };
                    } else {
                        // If app doesn't exist yet, create it
                        window.app = window.app || {};
                        window.app.exploreDepartment = (deptId) => {
                            this.selectDepartment(deptId);
                        };
                    }
                };
                
                // Try to override immediately, then retry if needed
                overrideExplore();
                setTimeout(overrideExplore, 100);
                setTimeout(overrideExplore, 500);
                
                // Check if department ID is in URL
                const urlParams = new URLSearchParams(window.location.search);
                const departmentId = urlParams.get('department');
                
                if (departmentId) {
                    // Wait for appData to load, then auto-select department
                    const waitForData = () => {
                        if (window.appData && window.appData.departments) {
                            this.departments = window.appData.departments;
                            const deptId = parseInt(departmentId);
                            const department = this.departments.find(d => d.id === deptId);
                            if (department) {
                                this.selectedDepartment = department;
                                this.showCareerPaths();
                            }
                        } else {
                            setTimeout(waitForData, 100);
                        }
                    };
                    waitForData();
                }
                
                this.initEventListeners();
            }
            
            selectDepartment(deptId) {
                // Try to find department from appData first, then from local departments
                const department = window.appData?.departments?.find(d => d.id === deptId) || 
                                   this.departments.find(d => d.id === deptId);
                
                if (!department) {
                    console.error('Department not found:', deptId);
                    return;
                }
                
                this.selectedDepartment = department;
                this.showCareerPaths();
            }
            
            showCareerPaths() {
                const departmentSection = document.getElementById('department-selector');
                const pathDetails = document.getElementById('pathDetails');
                
                if (departmentSection) departmentSection.style.display = 'none';
                if (pathDetails) pathDetails.style.display = 'block';
                
                const pathTitle = document.getElementById('pathTitle');
                const pathDescription = document.getElementById('pathDescription');
                
                if (pathTitle) pathTitle.textContent = this.selectedDepartment.name;
                if (pathDescription) pathDescription.textContent = this.selectedDepartment.description || 'Explore career paths for this department';
                
                // Show career paths list first, then load first path by default
                if (this.selectedDepartment.careerPaths?.length > 0) {
                    // Show career paths selector
                    this.showCareerPathsList();
                    // Load first career path by default
                    this.selectPath(this.selectedDepartment.careerPaths[0].id);
                } else {
                    // No career paths available
                    this.loadRoadmap(null);
                    this.loadSkills(null);
                    this.loadCourses(null);
                    this.loadJobs(null);
                }
                
            }
            
            showCareerPathsList() {
                // Create or update career paths selector
                let pathsSelector = document.getElementById('careerPathsSelector');
                if (!pathsSelector) {
                    const pathHeader = document.querySelector('.path-header');
                    if (pathHeader) {
                        pathsSelector = document.createElement('div');
                        pathsSelector.id = 'careerPathsSelector';
                        pathsSelector.className = 'mb-4';
                        pathHeader.appendChild(pathsSelector);
                    }
                }
                
                if (pathsSelector && this.selectedDepartment.careerPaths?.length > 0) {
                    pathsSelector.innerHTML = `
                        <h4 class="mb-3">Available Career Paths</h4>
                        <div class="row">
                            ${this.selectedDepartment.careerPaths.map(path => `
                                <div class="col-md-6 mb-3">
                                    <div class="career-path-card ${this.selectedPath?.id === path.id ? 'active' : ''}" 
                                         onclick="careerPaths.selectPath('${path.id}')">
                                        <h5>${path.title}</h5>
                                        <p class="text-muted small">${path.description}</p>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <span class="badge bg-info">${path.difficulty || 'Intermediate'}</span>
                                            <span class="text-muted small">${path.timeToHire || '3-6 months'}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            selectPath(pathId) {
                const path = this.selectedDepartment.careerPaths.find(p => p.id === pathId);
                if (!path) return;
                
                this.selectedPath = path;
                
                // Update path details
                const pathTitle = document.getElementById('pathTitle');
                const pathDescription = document.getElementById('pathDescription');
                if (pathTitle) pathTitle.textContent = path.title;
                if (pathDescription) pathDescription.textContent = path.description;
                
                // Update active state in career paths list
                document.querySelectorAll('.career-path-card').forEach(card => {
                    card.classList.remove('active');
                });
                const activeCard = document.querySelector(`[onclick*="${pathId}"]`);
                if (activeCard) activeCard.classList.add('active');
                
                // Load roadmap
                this.loadRoadmap(path);
                
                // Load skills
                this.loadSkills(path);
                
                // Load courses
                this.loadCourses(path);
                
                // Load jobs
                this.loadJobs(path);
            }
            
            loadRoadmap(path) {
                const timeline = document.getElementById('roadmapTimeline');
                if (!timeline) return;
                
                const roadmap = path.roadmap || this.generateDefaultRoadmap();
                
                timeline.innerHTML = Object.entries(roadmap).map(([month, tasks]) => `
                    <div class="timeline-item">
                        <div class="timeline-date">${month}</div>
                        <div class="timeline-content">
                            <h5>${tasks[0] || 'Learning Phase'}</h5>
                            <p>${tasks[1] || 'Focus on skill development'}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            loadSkills(path) {
                const container = document.getElementById('skillsGrid');
                if (!container) return;
                
                const skills = path.skills || [
                    { name: 'JavaScript', level: 85, importance: 'High' },
                    { name: 'React', level: 80, importance: 'High' },
                    { name: 'Node.js', level: 75, importance: 'Medium' }
                ];
                
                container.innerHTML = skills.map(skill => `
                    <div class="col-md-4 mb-3">
                        <div class="skill-card">
                            <div class="skill-header">
                                <h5>${skill.name}</h5>
                                <span class="badge bg-${skill.importance === 'High' ? 'danger' : skill.importance === 'Medium' ? 'warning' : 'info'}">
                                    ${skill.importance}
                                </span>
                            </div>
                            <div class="skill-progress">
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${skill.level}%">${skill.level}%</div>
                                </div>
                            </div>
                            <div class="skill-resources">
                                <small>Resources: Online courses, documentation, projects</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            loadCourses(path) {
                const container = document.getElementById('coursesGrid');
                if (!container) return;
                
                // Get courses from dummy-data.js that match the career path skills
                const allCourses = window.appData?.courses || {};
                let relevantCourses = [];
                
                // Try to find courses matching the path's skills
                if (path.skills && path.skills.length > 0) {
                    const skillNames = path.skills.map(s => s.name.toLowerCase());
                    Object.entries(allCourses).forEach(([category, courses]) => {
                        courses.forEach(course => {
                            const courseName = course.name.toLowerCase();
                            if (skillNames.some(skill => courseName.includes(skill) || skill.includes(courseName.split(' ')[0]))) {
                                relevantCourses.push({ ...course, platform: category });
                            }
                        });
                    });
                }
                
                // Fallback to default courses if none found
                if (relevantCourses.length === 0) {
                    relevantCourses = path.courses || [
                        { name: 'Complete Web Developer Bootcamp', platform: 'Udemy', duration: '60h', rating: 4.7 },
                        { name: 'React Fundamentals', platform: 'Coursera', duration: '40h', rating: 4.6 }
                    ];
                }
                
                container.innerHTML = relevantCourses.slice(0, 4).map(course => `
                    <div class="col-md-6 mb-4">
                        <div class="course-card">
                            <div class="course-header">
                                <h5>${course.name}</h5>
                                <span class="badge bg-primary">${course.platform || 'Online'}</span>
                            </div>
                            <div class="course-details">
                                <p><i class="fas fa-clock"></i> ${course.duration || 'Self-paced'}</p>
                                <p><i class="fas fa-star"></i> ${course.rating || '4.5'}/5</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='courses.html'">View Course</button>
                        </div>
                    </div>
                `).join('');
            }
            
            loadJobs(path) {
                const container = document.getElementById('jobsGrid');
                if (!container) return;
                
                // Get jobs from dummy-data.js that match the career path
                const allJobs = window.appData?.jobListings || [];
                
                if (allJobs.length === 0) {
                    container.innerHTML = '<div class="col-12"><p class="text-muted">No job listings available at the moment.</p></div>';
                    return;
                }
                
                // Match jobs by department name first
                let matchingJobs = allJobs.filter(job => {
                    if (!job.department) return false;
                    return job.department.toLowerCase() === this.selectedDepartment.name.toLowerCase();
                });
                
                // If we have matches, further filter by career path title keywords
                if (matchingJobs.length > 0 && path && path.title) {
                    const pathTitle = path.title.toLowerCase();
                    const pathKeywords = pathTitle.split(' ').filter(word => word.length > 3); // Get meaningful keywords
                    
                    // Score jobs based on how well they match the career path
                    matchingJobs = matchingJobs.map(job => {
                        let score = 0;
                        const jobTitle = (job.title || '').toLowerCase();
                        const jobDesc = (job.description || '').toLowerCase();
                        const jobReqs = (job.requirements || []).map(r => String(r).toLowerCase());
                        
                        // Check if job title contains career path keywords
                        pathKeywords.forEach(keyword => {
                            if (jobTitle.includes(keyword)) score += 3;
                            if (jobDesc.includes(keyword)) score += 1;
                            if (jobReqs.some(req => req.includes(keyword))) score += 2;
                        });
                        
                        // Exact title match gets highest priority
                        if (jobTitle === pathTitle || jobTitle.includes(pathTitle) || pathTitle.includes(jobTitle)) {
                            score += 10;
                        }
                        
                        return { ...job, matchScore: score };
                    }).sort((a, b) => b.matchScore - a.matchScore);
                }
                
                // Take top 4 matching jobs, or all if less than 4
                const jobs = matchingJobs.length > 0 
                    ? matchingJobs.slice(0, 4).map(j => ({ 
                        title: j.title, 
                        company: j.company, 
                        salary: j.salary, 
                        location: j.location 
                    }))
                    : [];
                
                if (jobs.length === 0) {
                    container.innerHTML = '<div class="col-12"><p class="text-muted">No specific job listings found for this career path. Check the <a href="job-portal.html">Job Portal</a> for more opportunities.</p></div>';
                    return;
                }
                
                container.innerHTML = jobs.map(job => `
                    <div class="col-md-6 mb-4">
                        <div class="job-card">
                            <div class="job-header">
                                <h5>${job.title || 'Job Title'}</h5>
                                <span class="company">${job.company || 'Company'}</span>
                            </div>
                            <div class="job-details">
                                <p><i class="fas fa-dollar-sign"></i> ${job.salary || 'Competitive'}</p>
                                <p><i class="fas fa-map-marker-alt"></i> ${job.location || 'Location TBD'}</p>
                            </div>
                            <button class="btn btn-sm btn-gradient" onclick="window.location.href='job-portal.html'">View Details</button>
                        </div>
                    </div>
                `).join('');
            }
            
            generateDefaultRoadmap() {
                return {
                    'Month 1-3': ['Foundation Building', 'Learn core concepts and basic skills'],
                    'Month 4-6': ['Skill Development', 'Build projects and practice regularly'],
                    'Month 7-9': ['Portfolio Building', 'Create impressive projects for your portfolio'],
                    'Month 10-12': ['Job Preparation', 'Prepare resume, practice interviews, apply for jobs']
                };
            }
            
            initEventListeners() {
                // Back button
                document.getElementById('backToDepartments')?.addEventListener('click', () => {
                    const departmentSection = document.getElementById('department-selector');
                    const pathDetails = document.getElementById('pathDetails');
                    
                    if (departmentSection) {
                        departmentSection.style.display = 'block';
                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        // Clear URL parameter
                        window.history.pushState({}, '', 'career-paths.html');
                    }
                    if (pathDetails) pathDetails.style.display = 'none';
                    
                    this.selectedDepartment = null;
                    this.selectedPath = null;
                });
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.careerPaths = new CareerPaths();
            
            // Ensure exploreDepartment is overridden after initialization
            setTimeout(() => {
                if (window.app && window.careerPaths) {
                    window.app.exploreDepartment = (deptId) => {
                        // Convert to number if it's a string
                        const id = typeof deptId === 'string' ? parseInt(deptId) : deptId;
                        window.careerPaths.selectDepartment(id);
                    };
                }
            }, 100);
            
            // Also add click handlers directly to buttons as backup
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.explore-btn-front, .explore-btn');
                if (btn && btn.onclick) {
                    const onclickStr = btn.getAttribute('onclick');
                    if (onclickStr && onclickStr.includes('exploreDepartment')) {
                        // Extract department ID from onclick string
                        const match = onclickStr.match(/exploreDepartment\((\d+)\)/);
                        if (match && window.careerPaths) {
                            e.preventDefault();
                            e.stopPropagation();
                            const deptId = parseInt(match[1]);
                            window.careerPaths.selectDepartment(deptId);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>